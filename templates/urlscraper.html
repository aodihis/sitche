{% extends  "layout/base.html" %}
{% block css %}
    <style>
    td {
        width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block content %}
 <section class="hero is-danger is-fullheight-with-navbar">
    <div class="hero-body"> 
        <div class="container is-max-desktop">
            <div id="progress" style="display: none;">
                <p class="mb-2">Please wait, your web is on scrape</p>
                <progress  class="progress is-danger mt-3 mb-0" max="100">20%</progress>
                <span id="progress-detail" class="mt-0">Progress</span>
            </div>
            <form id="scrape-form">
                <h3 class="mb-2">Just enter your website URL</h3>
                <div class="field has-addons">
                <div class="control is-expanded">
                    <input class="input" name="url" type="text" placeholder="Put you web url here">
                </div>
                <div class="control">
                    <button class="button is-info">
                        &#8594
                    </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section> 

<section class="section" id="scrape-res-section" style="display: none;">
    <h2 class="title">Results</h2>
    <div id="results-scrape"></div>
</section>

<script>
    const form = document.getElementById('scrape-form');
    const progressBar = document.getElementById('progress');
    const progressDetail = document.getElementById('progress-detail')
    const resSec = document.getElementById('scrape-res-section')
    const resultSContainer = document.getElementById('results-scrape')
    let results = {}


    const onSubmit = () => {
        form.style.display = 'none';
        progressBar.style.display = 'block';
    };

    const onFinish = () => {
        form.style.display = 'block';
        progressBar.style.display = 'none';
        resSec.style.display = 'block';
        resSec.scrollIntoView();
    }

    // Function to create and populate the table
    const createTable = (data) => {
       // Create table elements
        const table = document.createElement('table');
        table.classList.add('table', 'is-fullwidth', 'is-striped');

        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        // Create table header
        const headerRow = document.createElement('tr');
        const thNo = document.createElement('th');
        thNo.style.width = '10%';
        thNo.textContent = 'No';
        const thUrl = document.createElement('th');
        thUrl.textContent = 'URL';
        headerRow.appendChild(thNo);
        headerRow.appendChild(thUrl);
        thead.appendChild(headerRow);

        // Create table rows
        data.forEach((url, index) => {
            const row = document.createElement('tr');

            const cellNo = document.createElement('th');
            cellNo.textContent = index + 1;
            row.appendChild(cellNo);

            const cellUrl = document.createElement('td');
            cellUrl.textContent = url;
            row.appendChild(cellUrl);

            tbody.appendChild(row);
        });

        // Append thead and tbody to the table
        table.appendChild(thead);
        table.appendChild(tbody);

        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'column is-half is-multiline table-container';
        wrapperDiv.appendChild(table);
        return wrapperDiv
  
    }

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(form);
        const scrapeUrl = formData.get('url')
        const url = `/scrape?url=${encodeURIComponent(scrapeUrl)}`;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    // If the server returns an error status (e.g., 500)
                    return response.text().then(errorMessage => {
                        throw new Error(errorMessage);
                    });
                }
                
                // Start the SSE connection using the same URL as in fetch
                const eventSource = new EventSource(url);
                
                onSubmit()
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    if (data.status == 'in-progress') {
                        progressDetail.innerHTML = `${data.progress} page(s) found.`;
                    }

                    if (data.status == 'complete') {
                        const results = data.data;
                        eventSource.close();

                        // Clear and update the results container
                        resultSContainer.innerHTML = '<h3>Links</h3>';
                        const internalLinksTable = createTable(results.links);
                        resultSContainer.appendChild(internalLinksTable);

                        if (results.external) {
                            const externalLinksTable = createTable(results.external);
                            resultSContainer.innerHTML += '<h3>External Links</h3>'; // Adding heading for external links
                            resultSContainer.appendChild(externalLinksTable);
                        }

                        onFinish(); // Call your finish function
                    }
                };

                eventSource.onerror = function(e) {
                    console.error("Error occurred during SSE communication.", e);
                    eventSource.close();
                };
            })
    .catch(error => {
        console.error("Fetch Error:", error.message);
    });


        
    });
</script>
{% endblock %}